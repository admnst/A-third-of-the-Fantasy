<!doctype html>
<html lang="zn">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1, user-scalable=no">
    <link rel="stylesheet" href="../css/bootstrap.min.css">
    <title>WebSocket</title>
</head>

<body class="container-lg">
    <div class="input-group mb-3 fixed-bottom container-lg">
        <input type="text" class="form-control" id="text">
        <div class="input-group-append dropup btn-group">
            <button class="btn btn-primary" id="write">Send</button>
            <div class="form-file">
                <input type="file" class="form-file-input" id="file">
                <label class="form-file-label" for="file">
                    <span class="form-file-button">Choose file</span>
                </label>
            </div>
        </div>
    </div>

    <span class="btn text-primary" id="connectingSpan" style="margin-left: -15px">Connecting</span>
    <span class="btn text-primary float-right" id="closeSpan">Close</span>
    <span class="btn text-primary float-right" id="refreshSpan">Refresh</span>
    <div id="msg" style="margin-bottom:100px"></div>
    <div id="footer"></div>
    <style>
        .form-control:focus {
            box-shadow: none
        }
    </style>
    <script>
        let globalWebsocket
        const websocketLifePeriod = () => {
            var webSocket = new WebSocket("wss://api.buguoheng.com/ws")
                // var webSocket = new WebSocket("ws://127.0.0.1:8091")
            const sockState = () => ['未连接', '连接成功，可通讯', '正在关闭', '连接已关闭或无法打开'][webSocket.readyState]
            globalWebsocket = webSocket

            webSocket.onopen = function(event) {
                document.getElementById("connectingSpan").innerHTML = "Connected"
                document.getElementById("connectingSpan").className = "btn text-primary"
                document.getElementById("closeSpan").innerHTML = "Close"
                document.getElementById("closeSpan").onclick = close
            }

            webSocket.onmessage = (event) => write(event.data, true)

            webSocket.onclose = function(event) {
                document.getElementById("connectingSpan").innerHTML = "Disconnect"
                document.getElementById("connectingSpan").className = "btn text-primary"
            }

            webSocket.onerror = (err) => console.log(err)

            const close = () => {
                webSocket.close()
                document.getElementById("closeSpan").innerHTML = 'Open'
                document.getElementById("closeSpan").onclick = websocketLifePeriod
            }

            const write = (data, flag) => {
                data = data || document.getElementById('text').value
                if (!flag) webSocket.send(data)
                if (typeof data == "string") {
                    let node = document.createElement('p')
                    node.className = globalWebsocket.readyState == 1 ? '' : ' text-danger'
                    node.innerHTML = data
                    writeFinaly(node)
                } else if (typeof data == "object") {
                    let reader = new FileReader()
                    reader.readAsDataURL(new Blob([data]))
                    reader.onload = function(e) {
                        var img = new Image()
                        img.style.maxWidth = "1296px"
                        img.src = e.target.result
                        let timer = setInterval(function() {
                            if (img.complete) {
                                img = (img.fileSize <= 0 || (img.width <= 0 && img.height <= 0)) ? saveShareContent(data, 'unnamed.txt') : img
                                writeFinaly(img)
                                clearInterval(timer)
                            }
                        }, 50)
                    }
                }
            }

            const saveShareContent = (content, fileName) => {
                let downLink = document.createElement('a')
                downLink.className = 'd-block'
                downLink.download = fileName
                let blob = new Blob([content])
                downLink.href = URL.createObjectURL(blob)
                downLink.innerHTML = fileName
                return downLink
            }

            const writeFinaly = (node) => {
                document.getElementById('text').value = ''
                document.getElementById("msg").appendChild(node)
                document.getElementById("footer").scrollIntoView()
                document.getElementById('text').focus()
            }

            document.getElementById('text').focus()
            document.addEventListener("keyup", event => event.keyCode == 13 ? write() : null)
            document.getElementById("closeSpan").addEventListener("click", () => close())
            document.getElementById("refreshSpan").addEventListener("click", () => location.reload())
            document.getElementById("write").addEventListener("click", () => write())
            document.getElementById("text").addEventListener("paste", (event) => write(event.clipboardData.items[0].getAsFile()))
            document.querySelector('#file').addEventListener('change', (event) => write(event.target.files[0]))
        }

        websocketLifePeriod()
    </script>
    <script src="../js/bootstrap.bundle.min.js"></script>
</body>

</html>
<!doctype html>
<html lang="zn">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1, user-scalable=no">
    <link rel="stylesheet" href="https://buguoheng.com/static/css/bootstrap.min.css">
    <link rel="icon" href="https://buguoheng.com/favicon.ico" type="image/ico">
    <title>WebSocket</title>
</head>

<body>
    <div class="fixed-bottom">
        <div class="input-group">
            <input type="text" class="form-control" id="text" style="background-color:transparent">
            <label class="btn btn-outline-primary disabled" id="send">Send</label>
            <input type="file" id="file" style="display: none;">
            <label class="form-file-button btn btn-outline-primary disabled" for="file" id="lableFile">File</label>
        </div>
    </div>
    <div id="msg" style="margin-bottom:0.1px"></div>
    <div id="footer"></div>
    <style>
        .form-control:focus {
            box-shadow: none
        }

        .btn-outline-primary {
            color: #0d6efd;
            border-color: #8bbafe;
        }

        ::-webkit-scrollbar {
            width: 0px;
        }

        body {
            overflow-x: hidden;
        }
    </style>
    <script>
        const bgi = [
            "repeating-linear-gradient(90deg, rgb(95, 152, 225) 0px, rgb(95, 152, 225) 10px,rgb(115, 164, 229) 10px, rgb(115, 164, 229) 20px,rgb(135, 175, 233) 20px, rgb(135, 175, 233) 30px,rgb(214, 222, 250) 30px, rgb(214, 222, 250) 40px,rgb(174, 199, 242) 40px, rgb(174, 199, 242) 50px,rgb(155, 187, 238) 50px, rgb(155, 187, 238) 60px,rgb(194, 210, 246) 60px, rgb(194, 210, 246) 70px)",
            "repeating-linear-gradient(0deg, hsla(346, 18%, 76%, 0.09) 0px, hsla(346, 18%, 76%, 0.09) 1px, transparent 1px, transparent 9px), repeating-linear-gradient(90deg, hsla(346, 18%, 76%, 0.09) 0px, hsla(346, 18%, 76%, 0.09) 1px, transparent 1px, transparent 9px), linear-gradient(90deg, hsl(253, 39%, 53%), hsl(253, 39%, 53%))",
        ]
        let ad = Math.round(Math.random() * (bgi.length - 1))
        document.body.style.backgroundImage = bgi[ad];
    </script>
    <script>
        let asd
        const cl = console.log

        let globalWebsocket
        const websocketLifePeriod = () => {
            var webSocket = new WebSocket("wss://api.buguoheng.com/ws")
            // var webSocket = new WebSocket("ws://127.0.0.1:8091")
            const sockState = () => ['未连接', '连接成功，可通讯', '正在关闭', '连接已关闭或无法打开'][webSocket.readyState]
            const reg = /\.(png|jpg|gif|jpeg|webp|ico|svg)$/;
            const regSvg = /\.(svg)$/;
            let currentFile
            globalWebsocket = webSocket

            //Websocket listen method
            webSocket.onopen = function (event) {
                document.getElementById("send").className = "btn btn-outline-primary"
                document.getElementById("lableFile").className = "form-file-button btn btn-outline-primary"
            }
            webSocket.onmessage = (event) => {
                if (typeof event.data == "string")
                    onmessageString(event.data)
                else if (typeof event.data == "object")
                    onmessageBinary(event.data)
            }
            webSocket.onclose = function (event) {
                document.getElementById("send").className = "btn btn-outline-primary disabled"
                document.getElementById("lableFile").className = "form-file-button btn btn-outline-primary disabled"
            }
            webSocket.onerror = (err) => console.log(err)

            const send = (data) => globalWebsocket.send(data)

            const onmessageString = (data) => {
                if (currentFile) {
                    currentFile.name = data
                    setFile(currentFile)
                    currentFile = null
                } else if (data) {
                    setString(data)
                }
            }
            const onmessageBinary = (data) => currentFile = data

            const sendString = (data) => {
                send(data)
                setString(data)
            }
            const setString = (data) => {
                let node = document.createElement('p')
                node.innerHTML = data
                writeFinaly(node)
            }

            //file/image
            const setFile = (data) => reg.test(data.name) ? setImage(data) : setFile3(data)
            const setImage = (data) => {
                let reader = new FileReader()
                if (regSvg.test(data.name)) {
                    reader.readAsText(new Blob([data]))
                    reader.onload = (e) => writeFinaly(e.target.result)
                } else {
                    reader.readAsDataURL(new Blob([data]))
                    reader.onload = function (e) {
                        var img = new Image()
                        img.src = e.target.result
                        writeFinaly(img)
                    }
                }
            }
            const setFile3 = (data) => {
                writeFinaly(createFileLink(data.name, data))
            }

            //paste image or not
            const paste = (data) => (data.length && data[0].type.indexOf('image') >= 0) ? sendFile(data[0].getAsFile()) : null

            const sendFile = (data) => {
                if (data.type == "change") data = data.target.files[0]
                send(data)
                send(data.name)
                setFile(data)
            }

            const createFileLink = (fileName, file) => {
                let downLink = document.createElement('a')
                downLink.className = 'd-block'
                downLink.download = fileName
                if (file) {
                    let blob = new Blob([file])
                    downLink.href = URL.createObjectURL(blob)
                }
                else {
                    downLink.href = fileName
                }
                downLink.innerHTML = fileName
                return downLink
            }

            const writeFinaly = (node) => {
                typeof node == "object" ? document.getElementById("msg").appendChild(node) : document.getElementById("msg").innerHTML += node
                document.getElementById('text').value = ''
                document.getElementById('text').focus()
                document.getElementById("footer").scrollIntoView()
            }

            document.getElementById('text').focus()

            //send message
            document.getElementById("send").addEventListener("click", () => sendString(document.getElementById('text').value))
            document.addEventListener("keyup", event => event.keyCode == 13 ? sendString(document.getElementById('text').value) : null)

            //send image/file
            document.getElementById('file').addEventListener('change', sendFile)
            // document.getElementById('file').removeEventListener('change', sendFile)
            document.getElementById("text").addEventListener("paste", (event) => paste(event.clipboardData.items))

            //oss
            const setClient = (json) => {
                let client = new OSS({
                    region: 'oss-cn-hangzhou',
                    accessKeyId: json['Credentials']['AccessKeyId'],
                    accessKeySecret: json['Credentials']['AccessKeySecret'],
                    stsToken: json['Credentials']['SecurityToken'],
                    bucket: 'bgh-open'
                    // secure: true
                });
                /*将元素节点类型字符串化*/
                function stringIze(obj) {
                    var o = document.createElement("div");
                    o.appendChild(obj);
                    return o.innerHTML;
                }
                const put = (data) => {
                    if (data.type == "change") data = data.target.files[0]
                    if (data.size < (1024 * 1024 * 3)) return sendFile(data)
                    client.put(data.name, data).then(function (r1) {
                        let link = createFileLink(r1.url)
                        sendString(stringIze(link))
                    }).catch(function (err) {
                        console.error(err);
                    });
                }

                document.querySelector('#file').removeEventListener('change', sendFile)
                document.querySelector('#file').addEventListener('change', put)
                console.log('oss is ready')
            }

            const HttpGetPure = (str, callBack) => {
                let xmlhttp = window.XMLHttpRequest ? new XMLHttpRequest() : new ActiveXObject("Microsoft.XMLHTTP")
                xmlhttp.onreadystatechange = () => { if (xmlhttp.readyState == 4 && xmlhttp.status == 200) { callBack(xmlhttp.responseText) } }
                xmlhttp.open("GET", str, true)
                xmlhttp.send()
            }

            HttpGetPure('https://api.buguoheng.com/php/sts.php', (res) => setClient(JSON.parse(res)))
        }

        websocketLifePeriod()
    </script>

    <script src="https://buguoheng.com/static/js/aliyun-oss-sdk-6.8.0.min.js"></script>
    <script>
    </script>
</body>

</html>
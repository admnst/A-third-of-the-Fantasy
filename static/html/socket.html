<!doctype html>
<html lang="zn">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>WebSocket</title>
</head>

<body>
    <div class="fixed-bottom container-lg">
        <div class="input-group mb-3">
            <input type="text" class="form-control" id="text" style="background-color:transparent">
            <label class="btn btn-danger" id="write">Send</label>
            <input type="file" id="file" style="display: none;">
            <label class="form-file-button btn btn-outline-primary" for="file">File</label>
        </div>
    </div>

    <div style="display: none;">
        <span class="btn text-primary" id="connectingSpan" style="margin-left: -15px">Connecting</span>
        <span class="btn text-primary float-right" id="closeSpan">Close</span>
        <span class="btn text-primary float-right" id="refreshSpan">Refresh</span>
    </div>

    <div id="msg" style="margin-bottom:100px"></div>
    <div id="footer"></div>
    <script>
        let globalWebsocket
        const websocketLifePeriod = () => {
            // var webSocket = new WebSocket("wss://api.buguoheng.com/ws")
            var webSocket = new WebSocket("ws://127.0.0.1:8091")
            const sockState = () => ['未连接', '连接成功，可通讯', '正在关闭', '连接已关闭或无法打开'][webSocket.readyState]
            globalWebsocket = webSocket

            webSocket.onopen = function(event) {
                document.getElementById("connectingSpan").innerHTML = "Connected"
                document.getElementById("connectingSpan").className = "btn text-primary"
                document.getElementById("closeSpan").innerHTML = "Close"
                document.getElementById("closeSpan").onclick = close
                document.getElementById("write").className = "btn btn-outline-primary"
            }

            webSocket.onmessage = (event) => write(event.data, true)

            webSocket.onclose = function(event) {
                document.getElementById("connectingSpan").innerHTML = "Disconnect"
                document.getElementById("connectingSpan").className = "btn text-danger"
                document.getElementById("write").className = "btn btn-danger"
            }

            webSocket.onerror = (err) => console.log(err)

            const close = () => {
                webSocket.close()
                document.getElementById("closeSpan").innerHTML = 'Open'
                document.getElementById("closeSpan").onclick = websocketLifePeriod
            }

            const write = (data, DontSend) => {
                if (DontSend && !data) return
                data = data || document.getElementById('text').value
                if (!DontSend) globalWebsocket.send(data)
                if (typeof data == "string") {
                    let node = document.createElement('p')
                    node.className = globalWebsocket.readyState == 1 ? '' : ' text-danger'
                    node.innerHTML = data
                    writeFinaly(node)
                } else if (typeof data == "object") {
                    let reader = new FileReader()
                    reader.readAsDataURL(new Blob([data]))
                    reader.onload = function(e) {
                        var img = new Image()
                            // img.style.maxWidth = "1296px"
                        img.src = e.target.result
                        let timer = setInterval(function() {
                            if (img.complete) {
                                img = (img.fileSize <= 0 || (img.width <= 0 && img.height <= 0)) ? saveFile(data, 'unnamed.txt') : img
                                writeFinaly(img)
                                clearInterval(timer)
                            }
                        }, 50)
                    }
                }
            }

            const saveFile = (content, fileName) => {
                let downLink = document.createElement('a')
                downLink.className = 'd-block'
                downLink.download = fileName
                let blob = new Blob([content])
                downLink.href = URL.createObjectURL(blob)
                downLink.innerHTML = fileName
                return downLink
            }

            const writeFinaly = (node) => {
                document.getElementById('text').value = ''
                document.getElementById("msg").appendChild(node)
                document.getElementById("footer").scrollIntoView()
                document.getElementById('text').focus()
            }

            document.getElementById('text').focus()
            document.addEventListener("keyup", event => event.keyCode == 13 ? write() : null)
            document.getElementById("closeSpan").onclick = close
            document.getElementById("refreshSpan").addEventListener("click", () => location.reload())
            document.getElementById("write").addEventListener("click", () => write())
            document.querySelector('#file').addEventListener('change', (event) => write(event.target.files[0]))
            document.getElementById("text").addEventListener("paste", (event) => (event.clipboardData.items.length && event.clipboardData.items[0].type.indexOf("image") !== -1) ? write(event.clipboardData.items[0].getAsFile()) : null)
        }

        websocketLifePeriod()
    </script>
    <link rel="stylesheet" href="https://buguoheng.com/static/css/bootstrap.min.css">
    <script src="https://buguoheng.com/static/js/bootstrap.bundle.min.js"></script>
    <link rel="icon" href="https://buguoheng.com/favicon.ico" type="image/gif">
    <style>
        .form-control:focus {
            box-shadow: none
        }
        
        .btn-outline-primary {
            color: #0d6efd;
            border-color: #8bbafe;
        }
        
         ::-webkit-scrollbar {
            width: 0px;
        }
        
        body {
            overflow-x: hidden;
        }
    </style>
</body>

</html>
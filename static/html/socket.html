<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1, user-scalable=no">
    <link rel="stylesheet" href="../css/bootstrap.min.css">
    <title>websocket</title>
</head>

<body class=" container-lg">
    <div class="input-group mb-3 fixed-bottom container-lg">
        <input type="text" class="form-control" id="text">
        <div class="input-group-append">
            <span class="input-group-text btn btn-primary" id="send" onclick="send()">Send</span>
        </div>
    </div>
    <a class="btn">Connecting</a>
    <a class="btn text-primary float-right">Close</a>
    <a class="btn text-primary float-right">Refresh</a>
    <div id="msg" style="margin-bottom:100px"></div>
    <div id="footer"></div>
    <style>
        .form-control:focus {
            box-shadow: none;
        }

        body {
            overflow-x: hidden;
        }
    </style>
    <script id="wsScript">
        const wwww = () => {
            var webSocket = new WebSocket("wss://api.buguoheng.com/ws");
            // var webSocket = new WebSocket("ws://127.0.0.1:8091");

            webSocket.onerror = function (err) {
                console.log(err);
            };

            webSocket.onopen = function (event) {
                console.log("open:" + sockState());
                document.getElementsByTagName("a")[0].innerHTML = "Connected";
                document.getElementsByTagName("a")[0].className = "btn text-primary"
                document.getElementsByTagName("a")[1].innerHTML = "Close"
                document.getElementsByTagName("a")[1].addEventListener("click", () => close())
            };

            webSocket.onmessage = function (event) {
                document.getElementById("msg").innerHTML += "<p>" + event.data + "</p>"
                document.getElementById("footer").scrollIntoView()
            };

            webSocket.onclose = function (event) {
                document.getElementsByTagName("a")[0].innerHTML = "Disconnect";
                document.getElementsByTagName("a")[0].className = "btn text-danger"
            }
            function sockState() {
                var status = ['未连接', '连接成功，可通讯', '正在关闭', '连接已关闭或无法打开'];
                return status[webSocket.readyState];
            }
            function send(msg) {
                if (!msg)
                    msg = document.getElementById('text').value;
                document.getElementById('text').value = '';
                webSocket.send(msg);
                document.getElementById("msg").innerHTML += "<div class='btn d-block text-left" + (webSocket.readyState == 1 ? '' : ' text-danger') + "'>" + msg + "</div>"
                document.getElementById("footer").scrollIntoView()
                document.getElementById('text').focus()
            };
            function close() {
                webSocket.close();
                // document.getElementsByTagName("a")[1].onclick = wwww
            }

            document.getElementById('text').focus()
            document.addEventListener("keyup", event => { if (event.keyCode == 13) { send() } })
            document.getElementsByTagName("a")[1].onclick = close
            document.getElementById("send").addEventListener("click", (event) => send(event.data))
            document.getElementsByTagName("a")[2].addEventListener("click", () => location.reload())
        }
        wwww()
    </script>
</body>

</html>
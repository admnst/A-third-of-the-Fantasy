<!doctype html>
<html lang="zn">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1, user-scalable=no">
    <link rel="stylesheet" href="https://buguoheng.com/static/css/bootstrap.min.css">
    <link rel="icon" href="https://buguoheng.com/favicon.ico" type="image/ico">
    <title>WebSocket</title>
</head>

<body style="background-image: url(https://api.buguoheng.com/php/bing.php);">
    <div class="fixed-bottom">
        <div class="input-group">
            <input type="text" class="form-control" id="text" style="background-color:transparent">
            <label class="btn btn-outline-primary disabled" id="send">Send</label>
            <input type="file" id="file" style="display: none;">
            <label class="form-file-button btn btn-outline-primary disabled" for="file" id="lableFile">File</label>
        </div>
    </div>
    <div id="msg"></div>
    <div id="footer"></div>
    <style>
        .form-control:focus {
            box-shadow: none
        }

        .btn-outline-primary {
            color: #0d6efd;
            border-color: #8bbafe;
        }

        ::-webkit-scrollbar {
            width: 0px;
        }

        body {
            overflow-x: hidden;
        }
    </style>
    <script>
        let asd
        const cl = console.log

        let globalWebsocket
        const websocketLifePeriod = (websocketUrl) => {
            var webSocket = new WebSocket(websocketUrl)
            const sockState = () => ['未连接', '连接成功，可通讯', '正在关闭', '连接已关闭或无法打开'][webSocket.readyState]
            const reg = /\.(png|jpg|gif|jpeg|webp|ico|svg)$/;
            const regSvg = /\.(svg)$/;
            let currentFile
            globalWebsocket = webSocket

            //Websocket listen method
            webSocket.onopen = function (event) {
                document.getElementById("send").className = "btn btn-outline-primary"
                document.getElementById("lableFile").className = "form-file-button btn btn-outline-primary"
                document.getElementById('text').disabled = false
            }
            webSocket.onmessage = (event) => {
                if (typeof event.data == "string")
                    onmessageString(event.data)
                else if (typeof event.data == "object")
                    onmessageBinary(event.data)
            }
            webSocket.onclose = function (event) {
                document.getElementById("send").className = "btn btn-danger disabled"
                document.getElementById("lableFile").className = "form-file-button btn btn-danger disabled"
                document.getElementById('text').disabled = true
            }
            webSocket.onerror = (err) => console.log(err)

            const send = (data) => globalWebsocket.send(data)

            const onmessageString = (data) => {
                if (currentFile) {
                    currentFile.name = data
                    setFile(currentFile)
                    currentFile = null
                } else if (data) {
                    setString(data)
                }
            }
            const onmessageBinary = (data) => currentFile = data

            const sendString = (data) => {
                send(data)
                setString(data)
            }
            const setString = (data) => {
                let node = document.createElement('p')
                node.innerHTML = data
                writeFinaly(node)
            }

            //file/image
            const setFile = (data) => reg.test(data.name) ? setImage(data) : setFile3(data)
            const setImage = (data) => {
                let reader = new FileReader()
                if (regSvg.test(data.name)) {
                    reader.readAsText(new Blob([data]))
                    reader.onload = (e) => writeFinaly(e.target.result)
                } else {
                    reader.readAsDataURL(new Blob([data]))
                    reader.onload = function (e) {
                        var img = new Image()
                        img.src = e.target.result
                        writeFinaly(img)
                    }
                }
            }
            const setFile3 = (data) => {
                writeFinaly(createFileLink(data.name, data))
            }

            //paste image or not
            const paste = (data) => (data.length && data[0].type.indexOf('image') >= 0) ? sendFile(data[0].getAsFile()) : null

            const sendFile = (data) => {
                if (data.type == "change") data = data.target.files[0]
                send(data)
                send(data.name)
                setFile(data)
            }

            const createFileLink = (fileName, file) => {
                let downLink = document.createElement('a')
                downLink.className = 'd-block'
                downLink.download = fileName
                if (file) {
                    let blob = new Blob([file])
                    downLink.href = URL.createObjectURL(blob)
                }
                else {
                    downLink.href = fileName
                }
                downLink.innerHTML = fileName
                return downLink
            }

            const writeFinaly = (node) => {
                document.getElementById("msg").appendChild(node)
                document.getElementById('text').value = ''
                document.getElementById('text').focus()
                var timer = setInterval(() => {
                    if (node.complete == undefined || node.complete) clearInterval(timer)
                    document.getElementById("footer").scrollIntoView()
                }, 10)
            }

            document.getElementById('text').focus()

            //send message
            document.getElementById("send").addEventListener("click", () => sendString(document.getElementById('text').value))
            document.addEventListener("keyup", event => event.keyCode == 13 ? sendString(document.getElementById('text').value) : null)

            //send image/file
            document.getElementById('file').addEventListener('change', sendFile)
            document.getElementById("text").addEventListener("paste", (event) => paste(event.clipboardData.items))

            //oss
            let client
            const setClient = (json) => {
                client = new OSS({
                    region: 'oss-cn-hangzhou',
                    accessKeyId: json['Credentials']['AccessKeyId'],
                    accessKeySecret: json['Credentials']['AccessKeySecret'],
                    stsToken: json['Credentials']['SecurityToken'],
                    bucket: 'bgh-open'
                    // secure: true
                });
            }
            const put = (data) => {
                if (data.type == "change") data = data.target.files[0]
                if (data.size < (1024 * 1024 * 3)) return sendFile(data)
                if (typeof OSS != "undefined") clientPut(data)
                else loadJS('https://buguoheng.com/static/js/aliyun-oss-sdk-6.8.0.min.js', () => HttpGetPure('https://api.buguoheng.com/php/sts.php', (res) => clientPut(data, setClient(JSON.parse(res)))))
            }
            const clientPut = (data) => {
                var index = data.name.lastIndexOf(".") == -1 ? data.name.length : data.name.lastIndexOf(".");
                let name = data.name.slice(0, index) + '-' + Date.now() + data.name.slice(index)
                client.put(name, data).then(function (r1) {
                    let link = createFileLink(r1.url)
                    let div = document.createElement("div")
                    div.append(link)
                    sendString(div.innerHTML)
                }).catch(function (err) {
                    console.error(err);
                });
            }
            document.querySelector('#file').removeEventListener('change', sendFile)
            document.querySelector('#file').addEventListener('change', put)

            const HttpGetPure = (str, callBack) => {
                let xmlhttp = window.XMLHttpRequest ? new XMLHttpRequest() : new ActiveXObject("Microsoft.XMLHTTP")
                xmlhttp.onreadystatechange = () => { if (xmlhttp.readyState == 4 && xmlhttp.status == 200) { callBack(xmlhttp.responseText) } }
                xmlhttp.open("GET", str, true)
                xmlhttp.send()
            }
            const loadJS = function (url, callback) {
                let script = document.createElement('script')
                script.src = url
                script.type = "text/javascript"
                script.onload = () => callback()
                document.body.appendChild(script)
            }
        }

        websocketLifePeriod("wss://api.buguoheng.com/ws")
    </script>
</body>

</html>
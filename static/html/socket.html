<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1, user-scalable=no">
    <link rel="stylesheet" href="../css/bootstrap.min.css">
    <title>websocket</title>
</head>

<body class=" container-lg">
    <div class="input-group mb-3 fixed-bottom container-lg">
        <input type="text" class="form-control" id="text">
        <div class="input-group-append">
            <a class="input-group-text btn btn-primary" id="send">Send</a>
        </div>
    </div>
    <span>Connecting</span>
    <span class="btn text-primary float-right">Close</span>
    <span class="btn text-primary float-right">Refresh</span>
    <div id="msg" style="margin-bottom:100px"></div>
    <div id="footer"></div>
    <style>
        .form-control:focus {
            box-shadow: none;
        }
    </style>
    <script>
        let globalWebsocket
        const websocketLifePeriod = () => {
            var webSocket = new WebSocket("wss://api.buguoheng.com/ws");
            // var webSocket = new WebSocket("ws://127.0.0.1:8091");
            const sockState = () => ['未连接', '连接成功，可通讯', '正在关闭', '连接已关闭或无法打开'][webSocket.readyState]
            globalWebsocket = webSocket

            webSocket.onopen = function(event) {
                document.getElementsByTagName("span")[0].innerHTML = "Connected";
                document.getElementsByTagName("span")[0].className = "text-primary"
                document.getElementsByTagName("span")[1].innerHTML = "Close"
                document.getElementsByTagName("span")[1].onclick = close
            };

            webSocket.onmessage = function(event) {
                if (typeof event.data == "string") {
                    write(event.data)
                } else if (typeof event.data == "object") {
                    writeImage(event.data)
                }
            };

            webSocket.onclose = function(event) {
                document.getElementsByTagName("span")[0].innerHTML = "Disconnect";
                document.getElementsByTagName("span")[0].className = "text-danger"
            }

            webSocket.onerror = (err) => console.log(err)

            function send(msg) {
                if (typeof msg == "object") {
                    let reader = new FileReader()
                    reader.readAsArrayBuffer(msg.items[0].getAsFile())
                    reader.onload = () => globalWebsocket.send(reader.result)
                    writeImage(msg.items[0].getAsFile())
                    return
                }
                if (!msg) msg = document.getElementById('text').value;
                document.getElementById('text').value = '';
                globalWebsocket.send(msg);
                write(msg)
            }

            function close() {
                webSocket.close();
                document.getElementsByTagName("span")[1].innerHTML = 'Open'
                document.getElementsByTagName("span")[1].onclick = websocketLifePeriod
            }

            const write = (msg) => {
                document.getElementById("msg").innerHTML += "<p class='" + (globalWebsocket.readyState == 1 ? '' : ' text-danger') + "'>" + msg + "</p>"
                writeFinaly()
            }

            const writeImage = function(msg) {
                let reader = new FileReader()
                reader.onload = function(e) {
                    var img = new Image()
                    img.src = e.target.result
                    document.getElementById("msg").appendChild(img)
                    document.getElementById("footer").scrollIntoView()
                    writeFinaly()
                };
                reader.readAsDataURL(new Blob([msg]))
            }

            const writeFinaly = () => {
                document.getElementById("footer").scrollIntoView()
                document.getElementById('text').focus()
            }

            document.getElementById('text').focus()
            document.addEventListener("keyup", event => event.keyCode == 13 ? send() : '')
            document.getElementById("send").addEventListener("click", (event) => send(event.data))
            document.getElementById("text").addEventListener("paste", (event) => send(event.clipboardData))
            document.getElementsByTagName("span")[1].addEventListener("click", () => close())
            document.getElementsByTagName("span")[2].addEventListener("click", () => location.reload())
        }

        websocketLifePeriod()
    </script>
</body>

</html>